module Test.Testament.Issue where

import Daml.Script
import Main.Testament
import DA.Assert
import Test.Util


should_issue_testament = do
  -- given
  TestParties { provider, government } <- allocateParties

  -- when
  issueProposal <- submit provider do
    createCmd $ validProposal provider government
  
  testament <- submit government do
    exerciseCmd issueProposal SignIssue

  -- then
  Some actualTestament <- queryContractId government testament
  
  assertEq actualTestament $ validTestament provider government

  actualProposal <- queryContractId government issueProposal

  assertEq actualProposal None


should_validate_proposal = do
  parties@(TestParties { .. }) <- allocateParties

  -- empty issuer
  submitMustFail provider do
    createCmd $ issueProposal (Some "") None provider government

   -- blank issuer
  submitMustFail provider do
    createCmd $ issueProposal (Some "   ") None provider government

  shouldValidateInheritors provider \inheritors -> do
    createCmd $ issueProposal None (Some inheritors) provider government

  -- only provider should issue
  submitMustFail bank do
    createCmd $ validProposal bank government

  -- only government should SignIssue
  submitMustFail provider do
    createCmd $ validProposal provider bank


should_not_issue_twice = do
  TestParties { provider, government } <- allocateParties

  initialProposal <- submit provider do
    createCmd $ validProposal provider government
  
  testament <- submit government do
    exerciseCmd initialProposal SignIssue

  -- issue same issueProposal twice
  submitMustFail government do
    exerciseCmd initialProposal SignIssue

  duplicateProposal <- submit provider do
    createCmd $ validProposal provider government

  -- issue same testament twice
  submitMustFail government do
    exerciseCmd duplicateProposal SignIssue


should_issue_after_revoke = do
  TestParties { provider, government } <- allocateParties

  initialProposal <- submit provider do
    createCmd $ validProposal provider government
  
  testament <- submit government do
    exerciseCmd initialProposal SignIssue

  -- issue same issueProposal twice
  submitMustFail government do
    exerciseCmd initialProposal SignIssue

  duplicateProposal <- submit provider do
    createCmd $ validProposal provider government

  -- issue same testament twice
  submitMustFail government do
    exerciseCmd duplicateProposal SignIssue
